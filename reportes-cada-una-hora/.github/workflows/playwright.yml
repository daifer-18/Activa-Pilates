name: üß™ Playwright Tests - Reportes Autom√°ticos

on:
  # Ejecutar cada hora
  schedule:
    - cron: '0 * * * *'  # Cada hora en punto
  
  # Permitir ejecuci√≥n manual
  workflow_dispatch:
  
  # Ejecutar en cada push a main
  push:
    branches: [ main, master ]
  
  # Ejecutar en pull requests
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    name: üé≠ Ejecutar Pruebas E2E
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout del c√≥digo
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
      
      # 2. Configurar Node.js
      - name: üü¢ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. Instalar dependencias
      - name: üì¶ Instalar dependencias
        run: npm ci
      
      # 4. Instalar navegadores de Playwright
      - name: üåê Instalar navegadores Playwright
        run: npx playwright install --with-deps
      
      # 5. Ejecutar las pruebas
      - name: üß™ Ejecutar pruebas de Playwright
        run: npx playwright test pruebas.spec.ts
        continue-on-error: true
      
      # 6. Generar reporte JSON
      - name: üìä Generar reporte JSON
        run: npx playwright test pruebas.spec.ts --reporter=json > reporte-clean.json
        continue-on-error: true
      
      # 7. Generar reportes profesionales
      - name: üìà Generar reportes (HTML, CSV, Excel)
        run: node generarReportePRO.js
        continue-on-error: true
      
      # 8. Subir reportes como artefactos
      - name: üì§ Subir reportes como artefactos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: reportes-playwright-${{ github.run_number }}
          path: |
            reporte.html
            reporte.xlsx
            reporte.csv
            reporte-clean.json
            playwright-report/
          retention-days: 30
      
      # 9. Subir reporte HTML de Playwright
      - name: üìä Subir reporte HTML de Playwright
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_number }}
          path: playwright-report/
          retention-days: 30
      
      # 10. Comentar en PR con resultados (opcional)
      - name: üí¨ Comentar resultados en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let comment = '## üé≠ Resultados de Playwright\n\n';
            
            try {
              const report = JSON.parse(fs.readFileSync('reporte-clean.json', 'utf8'));
              let total = 0, passed = 0, failed = 0;
              
              report.suites.forEach(suite => {
                suite.specs.forEach(spec => {
                  spec.tests.forEach(test => {
                    total++;
                    if (test.results[0].status === 'passed') passed++;
                    else failed++;
                  });
                });
              });
              
              const successRate = ((passed / total) * 100).toFixed(2);
              
              comment += `### üìä Estad√≠sticas\n\n`;
              comment += `- **Total de pruebas:** ${total}\n`;
              comment += `- **‚úÖ Pasadas:** ${passed}\n`;
              comment += `- **‚ùå Fallidas:** ${failed}\n`;
              comment += `- **üìà Tasa de √©xito:** ${successRate}%\n\n`;
              
              if (failed > 0) {
                comment += `‚ö†Ô∏è **Hay pruebas fallidas. Revisa los artefactos para m√°s detalles.**\n`;
              } else {
                comment += `‚úÖ **¬°Todas las pruebas pasaron exitosamente!**\n`;
              }
            } catch (error) {
              comment += `‚ö†Ô∏è No se pudo leer el reporte de resultados.\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      # 11. Enviar notificaci√≥n por email (opcional - requiere configuraci√≥n)
      # - name: üìß Enviar email con reportes
      #   run: node enviarMail.js
      #   env:
      #     EMAIL_USER: ${{ secrets.EMAIL_USER }}
      #     EMAIL_PASS: ${{ secrets.EMAIL_PASS }}
      
      # 12. Subir a Google Drive (opcional - requiere configuraci√≥n)
      # - name: ‚òÅÔ∏è Subir a Google Drive
      #   run: node subirDrive.js
      #   env:
      #     GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

  # Job adicional para notificaciones
  notify:
    name: üì¢ Notificaciones
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: üìä Resumen de ejecuci√≥n
        run: |
          echo "========================================="
          echo "   RESUMEN DE EJECUCI√ìN"
          echo "========================================="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run Number: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Status: ${{ needs.test.result }}"
          echo "========================================="
